<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Notizen – TSV Handorf</title>
  <link rel="stylesheet" href="style.css">
  <style>
    main{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .list{padding:12px;display:grid;gap:10px;align-content:start}
    .item{display:grid;gap:4px;padding:10px;border:1px solid var(--border);border-radius:10px}
    .item .name{font-weight:800}
    .editor{padding:12px;display:grid;gap:12px}
    .rte-toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .rte{min-height:260px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
    .rte:focus{outline:2px solid rgba(14,165,233,.25)}
  </style>
</head>
<body data-feature="Notizen">
  <header class="app-header">
    <div class="left">
      <a href="index.html" class="btn btn-yellow">Startseite</a>
      <span id="userLabel" class="muted" style="display:none;"></span>
      <button id="logoutBtn" class="btn btn-ghost" style="display:none;">Logout</button>
    </div>
    <div class="right brand-pack">
      <div><h1 class="app-title">Notizen</h1><p class="app-sub">TSV Handorf</p></div>
      <img src="tsv-logo.jpg" alt="TSV Handorf Logo">
    </div>
  </header>

  <main class="container">
    <section class="card list">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="q" class="input" placeholder="Suchen (Titel & Inhalt)…">
        <button id="newBtn" class="btn">Neu</button>
      </div>
      <div id="list"></div>
      <div id="emptyList" class="muted" style="display:none">Noch keine Notizen. Mit <b>Neu</b> starten.</div>
    </section>

    <section class="card editor">
      <div class="toolbar" style="justify-content:space-between">
        <input id="title" class="input" placeholder="Titel der Notiz">
        <div class="toolbar">
          <button id="saveBtn" class="btn btn-yellow">Speichern</button>
          <button id="deleteBtn" class="btn btn-ghost">Löschen</button>
        </div>
      </div>

      <div class="rte-toolbar">
        <button class="btn" data-cmd="bold"><b>B</b></button>
        <button class="btn" data-cmd="italic"><i>I</i></button>
        <button class="btn" data-cmd="underline"><u>U</u></button>
        <button class="btn" data-cmd="insertUnorderedList">• Liste</button>
        <button class="btn" data-cmd="insertOrderedList">1. Liste</button>
        <button class="btn" data-cmd="formatBlock" data-value="H2">Überschrift</button>
        <button class="btn" data-cmd="formatBlock" data-value="P">Absatz</button>
      </div>

      <div id="rte" class="rte" contenteditable="true" spellcheck="true"></div>
      <div class="muted">Änderungen werden erst mit <b>Speichern</b> gesichert.</div>
    </section>
  </main>

  <script src="auth.js"></script>
  <script>
    if (window.Auth) { Auth.ready.then(() => Auth.requireAuth('auth.html')); }
    (function () {
      const label = document.getElementById('userLabel');
      const btn = document.getElementById('logoutBtn');
      function showUser(u) {
        if (!label || !btn) return;
        if (u) { label.textContent = u.email ? `Angemeldet: ${u.email}` : 'Angemeldet'; label.style.display = 'inline'; btn.style.display = 'inline-flex'; }
        else   { label.style.display = 'none'; btn.style.display = 'none'; }
      }
      if (window.Auth) {
        Auth.ready.then(() => { if (Auth.onAuth) Auth.onAuth(user => showUser(user)); });
        if (btn) btn.addEventListener('click', async () => { try { await Auth.signOut(); } finally { location.href = 'auth.html'; } });
      }
    })();
  </script>

  <script>
  (function(){
    const KEY='tsv_notes_v1';
    const listEl=document.getElementById('list'), emptyList=document.getElementById('emptyList'), q=document.getElementById('q');
    const title=document.getElementById('title'), rte=document.getElementById('rte');
    const newBtn=document.getElementById('newBtn'), saveBtn=document.getElementById('saveBtn'), deleteBtn=document.getElementById('deleteBtn');
    let currentId=null;

    function loadAll(){try{return JSON.parse(localStorage.getItem(KEY))||[]}catch(e){return[]}}
    function saveAll(a){localStorage.setItem(KEY,JSON.stringify(a))}
    function uid(){return 'n_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36)}
    function stripHtml(html){const d=document.createElement('div'); d.innerHTML=html||''; return d.textContent||d.innerText||''}
    function escapeHtml(s){return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

    function readForm(){return{id:currentId||uid(),title:title.value.trim(),html:rte.innerHTML.trim(),updatedAt:Date.now()}}
    function writeForm(n){currentId=n?.id||null; title.value=n?.title||''; rte.innerHTML=n?.html||''}
    function clearForm(){writeForm(null)}

    function renderList(filter=''){const data=loadAll(); const f=(filter||'').toLowerCase();
      const items=data.filter(n=>{const t=(n.title+' '+stripHtml(n.html)).toLowerCase(); return !f||t.includes(f)})
        .sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      listEl.innerHTML=items.map(n=>`<div class="item">
          <div class="name">${escapeHtml(n.title||'(ohne Titel)')}</div>
          <div class="muted">${new Date(n.updatedAt||Date.now()).toLocaleString()}</div>
          <div class="toolbar" style="margin-top:6px">
            <button class="btn" data-act="open" data-id="${n.id}">Öffnen</button>
            <button class="btn btn-ghost" data-act="del" data-id="${n.id}">Löschen</button>
          </div>
        </div>`).join('');
      emptyList.style.display=items.length?'none':'block';
    }

    listEl.onclick=e=>{const b=e.target.closest('button'); if(!b)return; const id=b.dataset.id,act=b.dataset.act; const data=loadAll(); const idx=data.findIndex(n=>n.id===id);
      if(act==='open'&&idx>=0)writeForm(data[idx]);
      if(act==='del'&&idx>=0){if(confirm('Diese Notiz löschen?')){data.splice(idx,1); saveAll(data); renderList(q.value); if(currentId===id)clearForm();}}
    };
    newBtn.onclick=()=>clearForm(); q.oninput=()=>renderList(q.value);

    saveBtn.onclick=()=>{const n=readForm(); if(!n.title)return alert('Bitte Titel vergeben.');
      const data=loadAll(); const idx=data.findIndex(x=>x.id===n.id); if(idx>=0)data[idx]=n; else data.push(n); saveAll(data); renderList(q.value); writeForm(n);};
    deleteBtn.onclick=()=>{if(!currentId){clearForm();return} const data=loadAll(); const idx=data.findIndex(n=>n.id===currentId); if(idx>=0&&confirm('Diese Notiz löschen?')){data.splice(idx,1); saveAll(data); renderList(q.value); clearForm();}};

    document.querySelector('.rte-toolbar').onclick=e=>{
      const b=e.target.closest('button'); if(!b)return;
      const cmd=b.dataset.cmd, val=b.dataset.value; if(cmd==='formatBlock'){document.execCommand('formatBlock',false,val||'P');}
      else{document.execCommand(cmd,false,null);}
      rte.focus();
    };

    renderList(); clearForm();
  })();
  </script>
</body>
</html>
