<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Scouting Sheet – TSV Handorf</title>
  <link rel="stylesheet" href="style.css">
  <style>
    main{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .list{padding:12px;display:grid;gap:10px;align-content:start}
    .list .item{display:grid;gap:4px;padding:10px;border:1px solid var(--border);border-radius:10px}
    .list .name{font-weight:800}
    .sheet{padding:12px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body data-feature="Scouting Sheet">
  <header class="app-header">
    <div class="left">
      <a href="index.html" class="btn btn-yellow">Startseite</a>
      <span id="userLabel" class="muted" style="display:none;"></span>
      <button id="logoutBtn" class="btn btn-ghost" style="display:none;">Logout</button>
    </div>
    <div class="right brand-pack">
      <div><h1 class="app-title">Scouting Sheet</h1><p class="app-sub">TSV Handorf</p></div>
      <img src="tsv-logo.jpg" alt="TSV Handorf Logo">
    </div>
  </header>

  <main class="container">
    <section class="card list">
      <div class="toolbar" style="margin-bottom:8px">
        <input id="q" class="input" type="search" placeholder="Suchen (Gegner & Inhalte) …" />
        <button id="newBtn" class="btn">Neu</button>
      </div>
      <div id="list"></div>
      <div class="muted" id="emptyList" style="display:none">Noch keine Scouting Reports. Mit <b>Neu</b> starten.</div>
    </section>

    <section class="card sheet">
      <div class="toolbar" style="justify-content:space-between">
        <h2 id="formTitle" style="margin:0;font-size:16px">Neuer Scouting Report</h2>
        <div class="toolbar">
          <button id="saveBtn" class="btn btn-yellow">Speichern</button>
          <button id="pdfBtn" class="btn btn-blue">PDF exportieren</button>
          <button id="deleteBtn" class="btn btn-ghost">Löschen</button>
        </div>
      </div>

      <div class="grid">
        <div><label>Gegner</label><input id="opponent" class="input" placeholder="z. B. SC Greven 09"></div>
        <div><label>Grundordnung mit Ball</label><input id="formationWith" class="input" placeholder="z. B. 4-1-2-1-2"></div>
        <div><label>Grundordnung gegen den Ball</label><input id="formationAgainst" class="input" placeholder="z. B. 4-4-2"></div>
        <div></div>
      </div>

      <div><label>Spiel mit Ball</label><textarea id="playWith" class="input" placeholder="z. B. 6er fällt zwischen IV; Schiene häufig doppelt besetzt"></textarea></div>
      <div><label>Spiel gegen den Ball</label><textarea id="playAgainst" class="input" placeholder="z. B. Mann gegen Mann hoch"></textarea></div>

      <div class="grid">
        <div><label>Standards mit Ball</label><textarea id="setPiecesFor" class="input" placeholder="z. B. Ecke von rechts zum Tor, TW wird geblockt"></textarea></div>
        <div><label>Standards gegen den Ball</label><textarea id="setPiecesAgainst" class="input" placeholder="z. B. Mischung Raum-/Manndeckung; Blocks auflösen"></textarea></div>
      </div>

      <div><label>Besonderheiten</label><textarea id="notes" class="input" placeholder="z. B. sehr lange Einwürfe von beiden Seiten"></textarea></div>
      <div class="muted">Änderungen werden erst mit <b>Speichern</b> gesichert.</div>
    </section>
  </main>

  <script src="auth.js"></script>
  <script>
    if (window.Auth) { Auth.ready.then(() => Auth.requireAuth('auth.html')); }
    (function () {
      const label = document.getElementById('userLabel');
      const btn = document.getElementById('logoutBtn');
      function showUser(u) {
        if (!label || !btn) return;
        if (u) { label.textContent = u.email ? `Angemeldet: ${u.email}` : 'Angemeldet'; label.style.display = 'inline'; btn.style.display = 'inline-flex'; }
        else   { label.style.display = 'none'; btn.style.display = 'none'; }
      }
      if (window.Auth) {
        Auth.ready.then(() => { if (Auth.onAuth) Auth.onAuth(user => showUser(user)); });
        if (btn) btn.addEventListener('click', async () => { try { await Auth.signOut(); } finally { location.href = 'auth.html'; } });
      }
    })();
  </script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script>
  (function(){
    const KEY="tsv_scouting_reports_v1";
    const listEl=document.getElementById('list'), emptyList=document.getElementById('emptyList'), q=document.getElementById('q');
    const formTitle=document.getElementById('formTitle'), opponent=document.getElementById('opponent'), formationWith=document.getElementById('formationWith'), formationAgainst=document.getElementById('formationAgainst'), playWith=document.getElementById('playWith'), playAgainst=document.getElementById('playAgainst'), setPiecesFor=document.getElementById('setPiecesFor'), setPiecesAgainst=document.getElementById('setPiecesAgainst'), notes=document.getElementById('notes');
    const newBtn=document.getElementById('newBtn'), saveBtn=document.getElementById('saveBtn'), pdfBtn=document.getElementById('pdfBtn'), deleteBtn=document.getElementById('deleteBtn');
    let currentId=null;
    function loadAll(){try{return JSON.parse(localStorage.getItem(KEY))||[]}catch(e){return[]}}
    function saveAll(a){localStorage.setItem(KEY,JSON.stringify(a))}
    function uid(){return 'r_'+Math.random().toString(36).slice(2,8)+Date.now().toString(36)}
    function escapeHtml(s){return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
    function readForm(){return{id:currentId||uid(),opponent:opponent.value.trim(),formationWith:formationWith.value.trim(),formationAgainst:formationAgainst.value.trim(),playWith:playWith.value.trim(),playAgainst:playAgainst.value.trim(),setPiecesFor:setPiecesFor.value.trim(),setPiecesAgainst:setPiecesAgainst.value.trim(),notes:notes.value.trim(),updatedAt:Date.now()}}
    function writeForm(r){currentId=r&&r.id||null;opponent.value=r?.opponent||'';formationWith.value=r?.formationWith||'';formationAgainst.value=r?.formationAgainst||'';playWith.value=r?.playWith||'';playAgainst.value=r?.playAgainst||'';setPiecesFor.value=r?.setPiecesFor||'';setPiecesAgainst.value=r?.setPiecesAgainst||'';notes.value=r?.notes||'';formTitle.textContent=currentId?('Scouting Report bearbeiten – '+(r.opponent||'ohne Gegner')):'Neuer Scouting Report'}
    function clearForm(){writeForm(null)}
    function renderList(filter=''){const data=loadAll();const f=(filter||'').toLowerCase();const items=data.filter(r=>{const t=(r.opponent+' '+r.formationWith+' '+r.formationAgainst+' '+r.playWith+' '+r.playAgainst+' '+r.setPiecesFor+' '+r.setPiecesAgainst+' '+r.notes).toLowerCase();return !f||t.includes(f)}).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      listEl.innerHTML=items.map(r=>`<div class="item"><div class="name">${escapeHtml(r.opponent||'(ohne Gegner)')}</div><div class="muted">${new Date(r.updatedAt||Date.now()).toLocaleString()}</div><div class="toolbar" style="margin-top:6px"><button class="btn" data-act="open" data-id="${r.id}">Öffnen</button><button class="btn btn-ghost" data-act="del" data-id="${r.id}">Löschen</button></div></div>`).join('');
      emptyList.style.display=items.length?'none':'block';
    }
    listEl.addEventListener('click',e=>{const b=e.target.closest('button'); if(!b)return; const id=b.dataset.id,act=b.dataset.act; const data=loadAll(); const idx=data.findIndex(r=>r.id===id); if(act==='open'&&idx>=0)writeForm(data[idx]); if(act==='del'&&idx>=0){if(confirm('Diesen Report wirklich löschen?')){data.splice(idx,1);saveAll(data);renderList(q.value); if(currentId===id)clearForm();}}});
    newBtn.onclick=()=>clearForm(); q.oninput=()=>renderList(q.value);
    saveBtn.onclick=()=>{const r=readForm(); if(!r.opponent)return alert('Bitte Gegner eintragen.'); const data=loadAll(); const idx=data.findIndex(x=>x.id===r.id); if(idx>=0)data[idx]=r; else data.push(r); saveAll(data); renderList(q.value); writeForm(r);};
    deleteBtn.onclick=()=>{if(!currentId){clearForm();return} const data=loadAll(); const idx=data.findIndex(r=>r.id===currentId); if(idx>=0&&confirm('Diesen Report wirklich löschen?')){data.splice(idx,1);saveAll(data);renderList(q.value);clearForm();}};
    pdfBtn.onclick=()=>{const r=readForm(); if(!r.opponent)return alert('Bitte zuerst Gegner eintragen und speichern.');
      if(!window.jspdf||!window.jspdf.jsPDF){alert('PDF-Bibliothek konnte nicht geladen werden.');return}
      const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}), margin=40;
      doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Scouting Sheet – TSV Handorf',margin,margin+16);
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text('Gegner: '+(r.opponent||''),margin,margin+40); doc.text('Stand: '+new Date(r.updatedAt||Date.now()).toLocaleString(),margin,margin+58);
      const rows=[['Grundordnung mit Ball',r.formationWith||''],['Grundordnung gegen den Ball',r.formationAgainst||''],['Spiel mit Ball',r.playWith||''],['Spiel gegen den Ball',r.playAgainst||''],['Standards mit Ball',r.setPiecesFor||''],['Standards gegen den Ball',r.setPiecesAgainst||''],['Besonderheiten',r.notes||'']];
      if(doc.autoTable){doc.autoTable({startY:margin+80,head:[['Bereich','Inhalt']],body:rows,styles:{cellPadding:6,valign:'top',overflow:'linebreak'},headStyles:{fillColor:[255,212,0],textColor:[0,0,0]},columnStyles:{0:{cellWidth:190,fontStyle:'bold'},1:{cellWidth:'auto'}},theme:'grid'});}
      else{let y=margin+90; doc.setFont('helvetica','bold'); doc.text('Bereich',margin,y); doc.text('Inhalt',margin+200,y); y+=12; doc.setFont('helvetica','normal'); rows.forEach(([k,v])=>{doc.text(String(k),margin,y); doc.text(String(v||''),margin+200,y,{maxWidth:doc.internal.pageSize.getWidth()-margin-200}); y+=20;});}
      const safe=(r.opponent||'Gegner').replace(/[^a-z0-9_-]+/gi,'_'); const filename='Scouting_'+safe+'.pdf';
      try{const blob=doc.output('blob'); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);}catch(e){doc.save(filename);}
    };
    renderList(); clearForm();
  })();
  </script>
</body>
</html>
